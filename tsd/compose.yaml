services:
#sdfasdsafasfdsafsad
  tsdproxy:
    image: almeidapaulopt/tsdproxy:2
    secrets:
      - tsclientId
      - tsclientSecret
    environment:
      # Tell TSDProxy where to find the secrets (mounted by Docker)
      - TSDCLIENT_ID_FILE=/run/secrets/tsclientId
      - TSDCLIENT_SECRET_FILE=/run/secrets/tsclientSecret
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - datadir:/data
      - ../config:/config:ro # Read-only configuration files
    restart: unless-stopped
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      replicas: 1
    # Debugging command to verify secrets are mounted correctly
    command: >
      sh -c "
        echo 'Client ID file exists:' && 
        ls -la /run/secrets/tsclientId && 
        echo 'Content:' && 
        cat /run/secrets/tsclientId && 
        echo '---' && 
        echo 'Client Secret file exists:' && 
        ls -la /run/secrets/tsclientSecret && 
        echo 'Content length:' && 
        cat /run/secrets/tsclientSecret | wc -c &&
        /app/tsdproxy
      "
volumes:
  datadir:
secrets:
  tsclientId:
    external: true
  tsclientSecret:
    external: true